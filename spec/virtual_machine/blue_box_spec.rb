require 'spec_helper'
require 'travis/worker/virtual_machine/blue_box'
require 'metriks'
require 'metriks/reporter/librato_metrics'
require 'fog/bluebox/models/compute/server'

describe Travis::Worker::VirtualMachine::BlueBox do
  describe "#new" do
    blue_box = described_class.new('blue_box')
  end

  describe "#create_server" do
    context 'when everything is good' do
      before :all do
        stub_request(:get, 'https://boxpanel.bluebox.net/api/block_templates.json').
          to_return(:status => 200, :headers => {}, :body => '[{"id":"a8f05200-7638-47d1-8282-2474ef57c4c3","status":"stored","description":"Scientific Linux 6 (Latest Release)","public":true,"locations":["37c2bd9a-3e81-46c9-b6e2-db44a25cc675","7506e315-5b1d-4959-a876-0caef9ba8824","016cdf0f-821b-4bed-8b9c-cd46f02c2363"],"created":"2011-11-28T13:36:04-08:00"},{"id":"0fde0384-211d-42ef-b2e7-049a4b0673ce","status":"stored","description":"Debian 7.4 i386 bare 20140409","public":true,"locations":["37c2bd9a-3e81-46c9-b6e2-db44a25cc675","7506e315-5b1d-4959-a876-0caef9ba8824","016cdf0f-821b-4bed-8b9c-cd46f02c2363"],"created":"2014-04-08T23:46:29-07:00"},{"id":"7dc9fdb1-a94c-452d-92dc-97357a18468f","status":"stored","description":"Debian 7.4 amd64 bare 20140423","public":true,"locations":["37c2bd9a-3e81-46c9-b6e2-db44a25cc675","7506e315-5b1d-4959-a876-0caef9ba8824","016cdf0f-821b-4bed-8b9c-cd46f02c2363"],"created":"2014-04-23T00:46:28-07:00"},{"id":"e810d665-d1f6-4fd5-9006-89db40eabe91","status":"stored","description":"Debian 7.5 amd64 bare 20140702","public":true,"locations":["37c2bd9a-3e81-46c9-b6e2-db44a25cc675","7506e315-5b1d-4959-a876-0caef9ba8824","016cdf0f-821b-4bed-8b9c-cd46f02c2363"],"created":"2014-07-02T00:45:26-07:00"},{"id":"42becfe2-63a0-4479-846d-555b0a1669bd","status":"stored","description":"Debian 7.5 i386 bare 20140709","public":true,"locations":["37c2bd9a-3e81-46c9-b6e2-db44a25cc675","016cdf0f-821b-4bed-8b9c-cd46f02c2363","7506e315-5b1d-4959-a876-0caef9ba8824"],"created":"2014-07-08T23:48:44-07:00"},{"id":"bbcb9ef8-e7a4-4f1d-94c7-2348f1e80499","status":"stored","description":"travis-jvm-2014-07-15-14-37","public":false,"locations":["016cdf0f-821b-4bed-8b9c-cd46f02c2363"],"created":"2014-07-15T07:37:23-07:00"},{"id":"cbeb64be-ca4b-4062-81f8-5523ad3a8248","status":"stored","description":"Debian jessie/sid amd64 bare 20140813","public":true,"locations":["37c2bd9a-3e81-46c9-b6e2-db44a25cc675","016cdf0f-821b-4bed-8b9c-cd46f02c2363","7506e315-5b1d-4959-a876-0caef9ba8824"],"created":"2014-08-13T02:45:53-07:00"},{"id":"ffacbdbe-9bb8-4e7d-a9cb-7d04cb925bfd","status":"stored","description":"debug-BanzaiMan-provisioning-ruby-1408970468.c45665-img-August 28, 2014 11:11","public":false,"locations":["016cdf0f-821b-4bed-8b9c-cd46f02c2363"],"created":"2014-08-28T11:11:59-07:00"},{"id":"18ce6892-c73b-449b-9a8f-c4a0ac5e49c0","status":"stored","description":"travis-update-standard-2014-08-28-23-34-cf95d0f","public":false,"locations":["016cdf0f-821b-4bed-8b9c-cd46f02c2363"],"created":"2014-08-28T12:56:36-07:00"},{"id":"0a037a2c-ae9c-4d0d-9ba4-b63956189a12","status":"stored","description":"travis-go-2014-08-28-20-08-cf95d0f","public":false,"locations":["016cdf0f-821b-4bed-8b9c-cd46f02c2363"],"created":"2014-08-28T13:08:12-07:00"},{"id":"6d6b5228-34e9-44e2-9a45-c3695e002a2a","status":"stored","description":"travis-jvm-2014-08-28-20-10-cf95d0f","public":false,"locations":["016cdf0f-821b-4bed-8b9c-cd46f02c2363"],"created":"2014-08-28T13:10:21-07:00"},{"id":"ff7bd191-f433-4830-b7aa-facdba33674b","status":"stored","description":"travis-node-js-2014-08-28-20-11-cf95d0f","public":false,"locations":["016cdf0f-821b-4bed-8b9c-cd46f02c2363"],"created":"2014-08-28T13:11:32-07:00"},{"id":"1a6b5ff1-850e-4b8b-a1d6-f222f31ac9fe","status":"stored","description":"travis-android-2014-08-28-20-12-cf95d0f","public":false,"locations":["016cdf0f-821b-4bed-8b9c-cd46f02c2363"],"created":"2014-08-28T13:12:24-07:00"},{"id":"6625760a-6579-45d9-8fec-acd41ce32c49","status":"stored","description":"travis-haskell-2014-08-28-20-13-cf95d0f","public":false,"locations":["016cdf0f-821b-4bed-8b9c-cd46f02c2363"],"created":"2014-08-28T13:13:32-07:00"},{"id":"7f3bb248-7bf2-41aa-a8c2-d00f426803ee","status":"stored","description":"travis-ruby-2014-08-28-20-46-cf95d0f","public":false,"locations":["016cdf0f-821b-4bed-8b9c-cd46f02c2363"],"created":"2014-08-28T13:46:37-07:00"},{"id":"4f6d0224-ff1d-4eb1-abcd-1f453ac1b0fb","status":"stored","description":"travis-python-2014-08-28-20-54-cf95d0f","public":false,"locations":["016cdf0f-821b-4bed-8b9c-cd46f02c2363"],"created":"2014-08-28T13:54:05-07:00"},{"id":"0976f0ce-022a-4ffb-aa7b-e6c0c57bb822","status":"stored","description":"travis-php-2014-08-28-22-14-cf95d0f","public":false,"locations":["016cdf0f-821b-4bed-8b9c-cd46f02c2363"],"created":"2014-08-28T15:14:30-07:00"},{"id":"4d0e7e03-3230-40f8-817a-6e8271e39e0c","status":"stored","description":"travis-perl-2014-08-28-22-29-cf95d0f","public":false,"locations":["016cdf0f-821b-4bed-8b9c-cd46f02c2363"],"created":"2014-08-28T15:29:00-07:00"},{"id":"91a1a60d-616f-4efe-9bb4-c855422664bc","status":"stored","description":"travis-erlang-2014-08-28-23-34-cf95d0f","public":false,"locations":["016cdf0f-821b-4bed-8b9c-cd46f02c2363"],"created":"2014-08-28T16:34:12-07:00"},{"id":"87f453c1-e9c0-472b-8c6a-975d1ec66bb6","status":"stored","description":"Ubuntu 10.04 LTS i386 bare 20140903","public":true,"locations":["37c2bd9a-3e81-46c9-b6e2-db44a25cc675","016cdf0f-821b-4bed-8b9c-cd46f02c2363","7506e315-5b1d-4959-a876-0caef9ba8824"],"created":"2014-09-02T21:27:14-07:00"},{"id":"d4828352-de61-464e-84a3-0a4710ad883f","status":"stored","description":"Ubuntu 10.04 LTS amd64 bare 20140903","public":true,"locations":["37c2bd9a-3e81-46c9-b6e2-db44a25cc675","016cdf0f-821b-4bed-8b9c-cd46f02c2363","7506e315-5b1d-4959-a876-0caef9ba8824"],"created":"2014-09-02T22:26:58-07:00"},{"id":"797e0196-40bc-40a7-bc6a-453442aa3cea","status":"stored","description":"Ubuntu 12.04 LTS i386 bare 20140903","public":true,"locations":["37c2bd9a-3e81-46c9-b6e2-db44a25cc675","016cdf0f-821b-4bed-8b9c-cd46f02c2363","7506e315-5b1d-4959-a876-0caef9ba8824"],"created":"2014-09-02T23:26:45-07:00"},{"id":"c30cda47-7fc4-4df7-ac68-86bd06a82b71","status":"stored","description":"Scientific Linux release 6.5 (Carbon) x86_64 bare 20140903","public":true,"locations":["37c2bd9a-3e81-46c9-b6e2-db44a25cc675","7506e315-5b1d-4959-a876-0caef9ba8824","016cdf0f-821b-4bed-8b9c-cd46f02c2363"],"created":"2014-09-02T23:29:49-07:00"},{"id":"8f00dc92-d78c-45f1-9cd2-c6e628fbdb33","status":"stored","description":"Debian 7.6 i386 bare 20140903","public":true,"locations":["37c2bd9a-3e81-46c9-b6e2-db44a25cc675","016cdf0f-821b-4bed-8b9c-cd46f02c2363","7506e315-5b1d-4959-a876-0caef9ba8824"],"created":"2014-09-02T23:45:29-07:00"},{"id":"a07cbbe6-bbac-4353-afa6-ea8984e2a196","status":"stored","description":"Scientific Linux release 6.5 (Carbon) i386 bare 20140903","public":true,"locations":["37c2bd9a-3e81-46c9-b6e2-db44a25cc675","016cdf0f-821b-4bed-8b9c-cd46f02c2363","7506e315-5b1d-4959-a876-0caef9ba8824"],"created":"2014-09-02T23:59:51-07:00"},{"id":"13224077-3a99-406e-a242-125ee016eecb","status":"stored","description":"Ubuntu 12.04 LTS amd64 bare 20140903","public":true,"locations":["37c2bd9a-3e81-46c9-b6e2-db44a25cc675","016cdf0f-821b-4bed-8b9c-cd46f02c2363","7506e315-5b1d-4959-a876-0caef9ba8824"],"created":"2014-09-03T00:27:13-07:00"},{"id":"590de729-1e3f-4005-b826-332ac9bfbca6","status":"stored","description":"CentOS release 6.5 (Final) x86_64 bare 20140903","public":true,"locations":["37c2bd9a-3e81-46c9-b6e2-db44a25cc675","016cdf0f-821b-4bed-8b9c-cd46f02c2363","7506e315-5b1d-4959-a876-0caef9ba8824"],"created":"2014-09-03T00:29:32-07:00"},{"id":"f15a467e-c4f3-4f0b-9cf2-4969c7c2d9b1","status":"stored","description":"Debian 7.6 amd64 bare 20140903","public":true,"locations":["37c2bd9a-3e81-46c9-b6e2-db44a25cc675","016cdf0f-821b-4bed-8b9c-cd46f02c2363","7506e315-5b1d-4959-a876-0caef9ba8824"],"created":"2014-09-03T00:45:29-07:00"},{"id":"f7ba2819-8965-4f3b-90e7-fc4eef69abbf","status":"stored","description":"CentOS release 6.5 (Final) i386 bare 20140903","public":true,"locations":["37c2bd9a-3e81-46c9-b6e2-db44a25cc675","016cdf0f-821b-4bed-8b9c-cd46f02c2363","7506e315-5b1d-4959-a876-0caef9ba8824"],"created":"2014-09-03T00:59:53-07:00"},{"id":"a670a8c7-57b3-4de7-82fa-17a9b8d1e560","status":"stored","description":"Ubuntu 13.10 i386 bare 20140903","public":true,"locations":["37c2bd9a-3e81-46c9-b6e2-db44a25cc675","016cdf0f-821b-4bed-8b9c-cd46f02c2363","7506e315-5b1d-4959-a876-0caef9ba8824"],"created":"2014-09-03T01:28:02-07:00"},{"id":"e672cf2c-f532-4a3e-960a-71b5c973051f","status":"stored","description":"Ubuntu 14.04 LTS i386 bare 20140903","public":true,"locations":["37c2bd9a-3e81-46c9-b6e2-db44a25cc675","016cdf0f-821b-4bed-8b9c-cd46f02c2363","7506e315-5b1d-4959-a876-0caef9ba8824"],"created":"2014-09-03T01:28:14-07:00"},{"id":"50b22ede-eb71-4cec-96c4-2035742d786d","status":"stored","description":"Debian jessie/sid i386 bare 20140903","public":true,"locations":["37c2bd9a-3e81-46c9-b6e2-db44a25cc675","016cdf0f-821b-4bed-8b9c-cd46f02c2363","7506e315-5b1d-4959-a876-0caef9ba8824"],"created":"2014-09-03T01:47:12-07:00"},{"id":"49ac5a3f-3ce5-46b4-b26e-80ad65d317ce","status":"stored","description":"Ubuntu 13.10 amd64 bare 20140903","public":true,"locations":["37c2bd9a-3e81-46c9-b6e2-db44a25cc675","7506e315-5b1d-4959-a876-0caef9ba8824","016cdf0f-821b-4bed-8b9c-cd46f02c2363"],"created":"2014-09-03T02:27:02-07:00"},{"id":"619ade6a-56f9-4eca-94a9-1129aa4a7b6a","status":"stored","description":"Ubuntu 14.04 LTS amd64 bare 20140903","public":true,"locations":["37c2bd9a-3e81-46c9-b6e2-db44a25cc675","016cdf0f-821b-4bed-8b9c-cd46f02c2363","7506e315-5b1d-4959-a876-0caef9ba8824"],"created":"2014-09-03T02:27:30-07:00"},{"id":"1626d053-57aa-4a9e-a022-215b83c2f076","status":"stored","description":"travis-perl-2014-09-03-20-57-0b1a64d","public":false,"locations":["016cdf0f-821b-4bed-8b9c-cd46f02c2363"],"created":"2014-09-03T13:57:57-07:00"},{"id":"f4ac422c-9c11-4087-b158-ef08b6bb44eb","status":"stored","description":"travis-php-2014-09-03-23-33-0b1a64d","public":false,"locations":["016cdf0f-821b-4bed-8b9c-cd46f02c2363"],"created":"2014-09-03T16:33:06-07:00"}]')
        stub_request(:get, 'https://boxpanel.bluebox.net/api/blocks.json').
          to_return(:status => 200, :headers => {}, :body => '[{"id":"1877a1e4-c3d6-4674-8534-54d48f4683e2","hostname":"testing-worker-linux-10-1-14390-linux-1-34724668.c45665.blueboxgrid.com","vsh_id":"f2507fb8-babf-4dbf-8fe5-34e0a6ff7243","description":"3 GB RAM + 20 GB Disk","memory":3221225472,"storage":21474836480,"cpu":1.5,"ips":[{"address":"2607:f700:8001:147:f7ce:d2c0:21fe:1909"}],"lb_applications":[],"status":"building","location_id":"77390972-b539-4766-b891-fa6c9bb8b76e"},{"id":"be26d9df-0fbe-416d-989c-72649cc0c381","hostname":"testing-worker-linux-10-1-14390-linux-10-34695320.c45665.blueboxgrid.com","vsh_id":"a2889456-c585-4d4f-aa93-40010bd0cc8a","description":"3 GB RAM + 20 GB Disk","memory":3221225472,"storage":21474836480,"cpu":1.5,"ips":[{"address":"2607:f700:8000:12d:89e:f3bc:143e:8c55"}],"lb_applications":[],"status":"running","location_id":"77390972-b539-4766-b891-fa6c9bb8b76e"}]')
        stub_request(:get, Addressable::Template.new("https://boxpanel.bluebox.net/api/blocks/{image_id}.json")).
          to_return(:status => 200, :headers => {}, :body => '{"id":"deadbeef-c3d6-4674-8534-54d48f4683e2","hostname":"testing-worker-linux-10-1-14390-linux-1-34724668.c45665.blueboxgrid.com","vsh_id":"f2507fb8-babf-4dbf-8fe5-34e0a6ff7243","description":"3 GB RAM + 20 GB Disk","memory":3221225472,"storage":21474836480,"cpu":1.5,"ips":[{"address":"2607:f700:8001:147:f7ce:d2c0:21fe:1909"}],"lb_applications":[],"status":"building","location_id":"77390972-b539-4766-b891-fa6c9bb8b76e"}')
        stub_request(:post, 'https://boxpanel.bluebox.net/api/blocks.json').
          with(:query => hash_including({})).
          to_return(:status => 200, :headers => {}, :body => '{"id":"1877a1e4-c3d6-4674-8534-54d48f4683e2","ips": [{"address":"2607:f700:8000:12d:89e:f3bc:143e:8c55"}],"memory":3221225472,"storage":21474836480,"hostname":"testing-worker-linux-10-1-14390-linux-1-34724668.c45665.blueboxgrid.com","cpu":1.5,"status":"queued"}')
        @blue_box = described_class.new('blue_box')
      end

      before :example do
        allow_any_instance_of(Fog::Compute::Bluebox::Server).to receive(:ready?).and_return(true)
      end

      it 'returns empty array' do
        expect(@blue_box.create_server).to be_nil
      end

    end
  end
end
